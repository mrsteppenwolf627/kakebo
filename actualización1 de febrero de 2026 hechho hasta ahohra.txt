================================================================================
           KAKEBO AI - DOCUMENTACIÃ“N PARA DUMMIES
           ActualizaciÃ³n: 1 de Febrero de 2026
           Fase 1 Completada: Backend Profesional
================================================================================

Â¿QUÃ‰ ES KAKEBO?
---------------
Kakebo es una aplicaciÃ³n de finanzas personales basada en el mÃ©todo japonÃ©s
del mismo nombre. Te ayuda a controlar tus gastos organizÃ¡ndolos en 4 categorÃ­as:

  â€¢ SURVIVAL (Supervivencia): Comida, transporte, salud - lo que NECESITAS
  â€¢ OPTIONAL (Opcional): Ropa, restaurantes - lo que QUIERES pero no necesitas
  â€¢ CULTURE (Cultura): Libros, cursos, cine - ocio y desarrollo personal
  â€¢ EXTRA: Gastos inesperados y excepcionales

La app te permite registrar gastos, ver cuÃ¡nto llevas gastado cada mes,
y establecer presupuestos para no pasarte.


================================================================================
                    Â¿QUÃ‰ HEMOS CONSTRUIDO? (Fase 1)
================================================================================

Imagina una app como un restaurante:
- El FRONTEND es el comedor (lo que ves: menÃºs, mesas, decoraciÃ³n)
- El BACKEND es la cocina (donde se prepara todo, tÃº no lo ves pero es esencial)

En la Fase 1 hemos construido toda la "cocina" profesional.


--------------------------------------------------------------------------------
1. API REST - El MenÃº del Restaurante
--------------------------------------------------------------------------------

Â¿QuÃ© es?
Una API es como el menÃº de un restaurante. Define quÃ© "platos" (operaciones)
puedes pedir y cÃ³mo pedirlos.

REST es un estilo de organizaciÃ³n. Es como decir "los entrantes van primero,
luego los principales, luego los postres".

Â¿QuÃ© endpoints (platos) tenemos?

  GASTOS VARIABLES (/api/expenses)
  --------------------------------
  GET    /api/expenses         â†’ Ver todos tus gastos
  GET    /api/expenses?ym=2026-01  â†’ Ver gastos de enero 2026
  POST   /api/expenses         â†’ Crear un nuevo gasto
  GET    /api/expenses/123     â†’ Ver un gasto especÃ­fico
  PATCH  /api/expenses/123     â†’ Modificar un gasto
  DELETE /api/expenses/123     â†’ Eliminar un gasto

  GASTOS FIJOS (/api/fixed-expenses)
  ----------------------------------
  Son gastos que se repiten cada mes: alquiler, Netflix, gimnasio...

  GET    /api/fixed-expenses   â†’ Ver todos tus gastos fijos
  POST   /api/fixed-expenses   â†’ Crear un gasto fijo (ej: "Netflix, 15.99â‚¬/mes")
  PATCH  /api/fixed-expenses/123 â†’ Modificar (ej: subiÃ³ a 17.99â‚¬)
  DELETE /api/fixed-expenses/123 â†’ Cancelar suscripciÃ³n

  MESES (/api/months)
  -------------------
  Cada mes es un "perÃ­odo contable". Puedes cerrarlo cuando acabe.

  GET    /api/months           â†’ Ver todos tus meses
  POST   /api/months           â†’ Crear/obtener un mes (ej: enero 2026)
  PATCH  /api/months/123       â†’ Cerrar un mes (ya no puedes aÃ±adir gastos)

  CONFIGURACIÃ“N (/api/settings)
  -----------------------------
  Tu configuraciÃ³n personal: ingresos, presupuestos por categorÃ­a...

  GET    /api/settings         â†’ Ver tu configuraciÃ³n
  PATCH  /api/settings         â†’ Cambiar configuraciÃ³n

  DOCUMENTACIÃ“N (/api/docs)
  -------------------------
  GET    /api/docs             â†’ Ver la documentaciÃ³n tÃ©cnica de la API


--------------------------------------------------------------------------------
2. VALIDACIÃ“N CON ZOD - El Control de Calidad
--------------------------------------------------------------------------------

Â¿QuÃ© es?
Zod es como un guardia de seguridad que revisa todo lo que entra.

Ejemplo sin Zod (peligroso):
  Usuario envÃ­a: { amount: "hola", date: "ayer" }
  La app explota ğŸ’¥

Ejemplo con Zod (seguro):
  Usuario envÃ­a: { amount: "hola", date: "ayer" }
  Zod responde: "Error: amount debe ser un nÃºmero, date debe ser YYYY-MM-DD"
  La app sigue funcionando âœ…

Â¿DÃ³nde estÃ¡?
  src/lib/schemas/common.ts      â†’ Validaciones comunes (fechas, UUIDs, etc)
  src/lib/schemas/expense.ts     â†’ ValidaciÃ³n de gastos
  src/lib/schemas/month.ts       â†’ ValidaciÃ³n de meses
  src/lib/schemas/settings.ts    â†’ ValidaciÃ³n de configuraciÃ³n
  src/lib/schemas/fixed-expense.ts â†’ ValidaciÃ³n de gastos fijos


--------------------------------------------------------------------------------
3. AUTENTICACIÃ“N - El Portero del Club
--------------------------------------------------------------------------------

Â¿QuÃ© es?
Verifica que eres quien dices ser antes de dejarte hacer cualquier cosa.

Â¿CÃ³mo funciona?
1. Te registras/logueas con Supabase Auth (email, Google, etc.)
2. Recibes un "token" (como una pulsera de discoteca)
3. Cada vez que pides algo, muestras tu pulsera
4. Si no tienes pulsera vÃ¡lida â†’ Error 401 "No autorizado"

Â¿DÃ³nde estÃ¡?
  src/lib/api/auth.ts â†’ FunciÃ³n requireAuth() que verifica tu sesiÃ³n

AdemÃ¡s, cada usuario SOLO ve sus propios datos. Si tÃº tienes gastos y yo
tengo gastos, tÃº no puedes ver los mÃ­os ni yo los tuyos.


--------------------------------------------------------------------------------
4. MANEJO DE ERRORES - El Protocolo de Emergencias
--------------------------------------------------------------------------------

Â¿QuÃ© es?
Cuando algo sale mal, en vez de que la app explote, devuelve un mensaje
claro explicando quÃ© pasÃ³.

Tipos de errores que manejamos:

  400 Bad Request      â†’ "Lo que enviaste no tiene sentido"
  401 Unauthorized     â†’ "No has iniciado sesiÃ³n"
  403 Forbidden        â†’ "No tienes permiso para esto"
  404 Not Found        â†’ "Eso que buscas no existe"
  409 Conflict         â†’ "No puedes hacer eso (ej: mes cerrado)"
  422 Validation Error â†’ "Los datos no son vÃ¡lidos"
  500 Internal Error   â†’ "Algo fallÃ³ por nuestra parte"

Ejemplo de respuesta de error:
  {
    "success": false,
    "error": {
      "code": "VALIDATION_ERROR",
      "message": "Error de validaciÃ³n en 'amount': debe ser mayor que 0",
      "details": { "amount": ["debe ser mayor que 0"] }
    }
  }

Â¿DÃ³nde estÃ¡?
  src/lib/api/errors.ts    â†’ Clases de error y funciÃ³n handleApiError()
  src/lib/api/responses.ts â†’ Respuestas estandarizadas (ok, created, etc.)


--------------------------------------------------------------------------------
5. LOGGING - La Caja Negra del AviÃ³n
--------------------------------------------------------------------------------

Â¿QuÃ© es?
Registro de todo lo que pasa en la aplicaciÃ³n. Si algo falla, podemos
ver el "historial" para entender quÃ© pasÃ³.

Â¿QuÃ© registramos?
  â€¢ Cada peticiÃ³n que llega (quiÃ©n, quÃ© pidiÃ³, cuÃ¡ndo)
  â€¢ Cada respuesta que sale (cÃ³digo de estado, cuÃ¡nto tardÃ³)
  â€¢ Todos los errores (con detalle completo)

Ejemplo de log:
  [12:30:45] INFO: POST /api/expenses (user: abc123)
  [12:30:45] INFO: POST /api/expenses -> 201 (45ms)

Â¿Por quÃ© es importante?
  â€¢ En desarrollo: ver quÃ© estÃ¡ pasando en tiempo real
  â€¢ En producciÃ³n: diagnosticar problemas sin acceso directo al servidor
  â€¢ MÃ©tricas: detectar endpoints lentos, errores frecuentes, etc.

Â¿DÃ³nde estÃ¡?
  src/lib/logger.ts         â†’ ConfiguraciÃ³n de pino (la librerÃ­a de logging)
  src/lib/api/withLogging.ts â†’ Middleware que envuelve cada endpoint


--------------------------------------------------------------------------------
6. TESTS - El Control de Calidad AutomÃ¡tico
--------------------------------------------------------------------------------

Â¿QuÃ© son?
Programas que verifican automÃ¡ticamente que todo funciona bien.
Es como tener un empleado que prueba cada funciÃ³n 1000 veces al dÃ­a.

Â¿CuÃ¡ntos tests tenemos?
  138 tests en total, distribuidos asÃ­:

  Tests de Schemas (validaciÃ³n):
    â€¢ expense.test.ts      â†’ 13 tests
    â€¢ fixed-expense.test.ts â†’ 18 tests
    â€¢ month.test.ts        â†’ 20 tests
    â€¢ settings.test.ts     â†’ 10 tests

  Tests de API (endpoints):
    â€¢ expenses.test.ts     â†’ 8 tests
    â€¢ fixed-expenses.test.ts â†’ 8 tests
    â€¢ months.test.ts       â†’ 6 tests
    â€¢ settings.test.ts     â†’ 6 tests

  Tests de utilidades:
    â€¢ errors.test.ts       â†’ 23 tests
    â€¢ responses.test.ts    â†’ 17 tests
    â€¢ logger.test.ts       â†’ 9 tests

Â¿QuÃ© es el "coverage"?
  Mide quÃ© porcentaje del cÃ³digo estÃ¡ siendo probado.

  Nuestros nÃºmeros:
    â€¢ Statements: 91% (lÃ­neas de cÃ³digo ejecutadas)
    â€¢ Branches: 84% (caminos if/else probados)
    â€¢ Functions: 97% (funciones llamadas)
    â€¢ Lines: 94% (similar a statements)

  El estÃ¡ndar de industria es 80%. Nosotros lo superamos âœ…

Â¿CÃ³mo ejecutar los tests?
  npm test              â†’ Ejecutar todos los tests
  npm test -- --coverage â†’ Ver el reporte de coverage

Â¿DÃ³nde estÃ¡n?
  src/__tests__/           â†’ Carpeta con todos los tests
  vitest.config.ts         â†’ ConfiguraciÃ³n del test runner


--------------------------------------------------------------------------------
7. DOCUMENTACIÃ“N OPENAPI - El Manual de Instrucciones
--------------------------------------------------------------------------------

Â¿QuÃ© es?
OpenAPI (antes Swagger) es un estÃ¡ndar para documentar APIs.
Es como el manual de instrucciones de un electrodomÃ©stico.

Â¿QuÃ© incluye nuestra documentaciÃ³n?
  â€¢ Todos los endpoints disponibles
  â€¢ QuÃ© parÃ¡metros acepta cada uno
  â€¢ QuÃ© formato debe tener el body
  â€¢ QuÃ© respuestas puede devolver
  â€¢ Ejemplos de uso

Â¿CÃ³mo acceder?
  GET http://localhost:3000/api/docs

  Devuelve un JSON que puedes importar en:
    â€¢ Postman (para probar la API)
    â€¢ Swagger UI (para ver documentaciÃ³n bonita)
    â€¢ Insomnia (alternativa a Postman)

Â¿DÃ³nde estÃ¡?
  src/lib/api/openapi.ts   â†’ La especificaciÃ³n completa
  src/app/api/docs/route.ts â†’ El endpoint que la sirve


================================================================================
                         ESTRUCTURA DE CARPETAS
================================================================================

kakebo/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â””â”€â”€ api/                    â† Endpoints de la API
â”‚   â”‚       â”œâ”€â”€ docs/               â† DocumentaciÃ³n OpenAPI
â”‚   â”‚       â”œâ”€â”€ expenses/           â† CRUD de gastos
â”‚   â”‚       â”œâ”€â”€ fixed-expenses/     â† CRUD de gastos fijos
â”‚   â”‚       â”œâ”€â”€ months/             â† CRUD de meses
â”‚   â”‚       â”œâ”€â”€ settings/           â† ConfiguraciÃ³n usuario
â”‚   â”‚       â””â”€â”€ health/             â† Health check
â”‚   â”‚
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ api/                    â† Utilidades de API
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.ts             â† AutenticaciÃ³n
â”‚   â”‚   â”‚   â”œâ”€â”€ errors.ts           â† Manejo de errores
â”‚   â”‚   â”‚   â”œâ”€â”€ responses.ts        â† Respuestas estÃ¡ndar
â”‚   â”‚   â”‚   â”œâ”€â”€ withLogging.ts      â† Middleware de logging
â”‚   â”‚   â”‚   â”œâ”€â”€ openapi.ts          â† DocumentaciÃ³n
â”‚   â”‚   â”‚   â””â”€â”€ index.ts            â† Re-exportaciones
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ schemas/                â† ValidaciÃ³n con Zod
â”‚   â”‚   â”‚   â”œâ”€â”€ common.ts           â† Tipos comunes
â”‚   â”‚   â”‚   â”œâ”€â”€ expense.ts          â† Schema de gastos
â”‚   â”‚   â”‚   â”œâ”€â”€ fixed-expense.ts    â† Schema de gastos fijos
â”‚   â”‚   â”‚   â”œâ”€â”€ month.ts            â† Schema de meses
â”‚   â”‚   â”‚   â”œâ”€â”€ settings.ts         â† Schema de config
â”‚   â”‚   â”‚   â””â”€â”€ index.ts            â† Re-exportaciones
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ logger.ts               â† ConfiguraciÃ³n de logging
â”‚   â”‚   â””â”€â”€ supabase/               â† Cliente de Supabase
â”‚   â”‚
â”‚   â””â”€â”€ __tests__/                  â† Tests
â”‚       â”œâ”€â”€ setup.ts                â† ConfiguraciÃ³n global
â”‚       â”œâ”€â”€ api/                    â† Tests de endpoints
â”‚       â”œâ”€â”€ lib/                    â† Tests de utilidades
â”‚       â””â”€â”€ schemas/                â† Tests de validaciÃ³n
â”‚
â”œâ”€â”€ vitest.config.ts                â† ConfiguraciÃ³n de tests
â””â”€â”€ package.json                    â† Dependencias del proyecto


================================================================================
                           TECNOLOGÃAS USADAS
================================================================================

FRAMEWORK
  â€¢ Next.js 14 (App Router) - Framework de React para web apps
  â€¢ TypeScript - JavaScript con tipos (menos errores)

BASE DE DATOS
  â€¢ Supabase - PostgreSQL en la nube + autenticaciÃ³n incluida

VALIDACIÃ“N
  â€¢ Zod - ValidaciÃ³n de datos con inferencia de tipos

TESTING
  â€¢ Vitest - Test runner rÃ¡pido (compatible con Jest)
  â€¢ @testing-library - Utilidades para tests

LOGGING
  â€¢ Pino - Logger de alto rendimiento para Node.js
  â€¢ pino-pretty - Formato legible para desarrollo

DOCUMENTACIÃ“N
  â€¢ OpenAPI 3.0 - EstÃ¡ndar de documentaciÃ³n de APIs


================================================================================
                         COMANDOS ÃšTILES
================================================================================

# Instalar dependencias
npm install

# Ejecutar en desarrollo
npm run dev

# Ejecutar tests
npm test

# Ver coverage de tests
npm test -- --coverage

# Verificar tipos de TypeScript
npx tsc --noEmit

# Ver documentaciÃ³n de la API
# (con el servidor corriendo)
curl http://localhost:3000/api/docs


================================================================================
                         Â¿QUÃ‰ SIGUE? (Pendiente)
================================================================================

  â€¢ Function calling
    â†’ La IA puede ejecutar acciones (crear gastos, consultar saldos)

  â€¢ Panel de evaluaciÃ³n del modelo
    â†’ Dashboard para ver cÃ³mo estÃ¡ funcionando la IA

  â€¢ Feedback loop
    â†’ Cuando el usuario corrige la IA, guardar esa correcciÃ³n para mejorar


================================================================================
     UPDATE - 1 de Febrero de 2026, ~13:25h (SesiÃ³n con Claude Opus 4.5)
================================================================================

FASE 2 PARCIALMENTE COMPLETADA - IA APLICADA
---------------------------------------------

Se implementÃ³ el sistema de clasificaciÃ³n inteligente de gastos:

1. CLIENTE OPENAI (src/lib/ai/client.ts)
   Â¿QuÃ© es? ConexiÃ³n con la API de OpenAI
   - Usa el modelo GPT-4o-mini (barato y suficiente para clasificar)
   - Costo estimado: ~$0.0001 por clasificaciÃ³n (prÃ¡cticamente gratis)
   - Calcula automÃ¡ticamente el costo de cada llamada

2. SISTEMA DE PROMPTS VERSIONADOS (src/lib/ai/prompts.ts)
   Â¿QuÃ© es? Las "instrucciones" que le damos a la IA
   - VersiÃ³n v1: 10 ejemplos bÃ¡sicos
   - VersiÃ³n v2: 28 ejemplos mÃ¡s completos (ACTIVA)
   - Permite cambiar entre versiones para comparar cuÃ¡l funciona mejor
   - Incluye descripciÃ³n de las 4 categorÃ­as Kakebo en espaÃ±ol

3. CLASIFICADOR (src/lib/ai/classifier.ts)
   Â¿QuÃ© es? La funciÃ³n que hace la magia
   - Recibe: "Mercadona 45â‚¬"
   - Devuelve: { category: "survival", note: "Compra supermercado", confidence: 0.95 }
   - TambiÃ©n devuelve mÃ©tricas: latencia, tokens usados, costo

4. ENDPOINT API (src/app/api/ai/classify/route.ts)
   Â¿CÃ³mo usarlo?

   POST /api/ai/classify
   Body: { "text": "Netflix mensual" }

   Respuesta:
   {
     "success": true,
     "data": {
       "category": "culture",
       "note": "SuscripciÃ³n streaming",
       "confidence": 0.98,
       "metrics": {
         "model": "gpt-4o-mini",
         "promptVersion": "v2",
         "latencyMs": 450,
         "inputTokens": 580,
         "outputTokens": 28,
         "costUsd": 0.0001
       }
     }
   }

   TambiÃ©n soporta batch (varios a la vez):
   Body: { "texts": ["Mercadona", "Netflix", "Gasolina"] }

5. TESTS (src/__tests__/ai/)
   - classifier.test.ts: 9 tests del clasificador
   - prompts.test.ts: 12 tests del sistema de prompts
   - Total proyecto: 159 tests pasando

ESTRUCTURA DE CARPETAS AÃ‘ADIDA:
   src/lib/ai/
   â”œâ”€â”€ client.ts      â†’ ConexiÃ³n con OpenAI
   â”œâ”€â”€ prompts.ts     â†’ Prompts versionados (v1, v2)
   â”œâ”€â”€ classifier.ts  â†’ FunciÃ³n de clasificaciÃ³n
   â””â”€â”€ index.ts       â†’ Re-exportaciones

   src/app/api/ai/
   â””â”€â”€ classify/
       â””â”€â”€ route.ts   â†’ Endpoint POST /api/ai/classify

   src/__tests__/ai/
   â”œâ”€â”€ classifier.test.ts
   â””â”€â”€ prompts.test.ts

   src/lib/schemas/
   â””â”€â”€ ai.ts          â†’ ValidaciÃ³n Zod para inputs de IA

CONFIGURACIÃ“N NECESARIA:
   AÃ±adir a .env.local:
   OPENAI_API_KEY=sk-...

   (Se obtiene en https://platform.openai.com/api-keys)


================================================================================
                              FIN
================================================================================

Documento creado: 1 de Febrero de 2026
Ãšltima actualizaciÃ³n: 1 de Febrero de 2026, ~13:25h
Autor: Claude Opus 4.5 + Aitor
VersiÃ³n: 1.1 - Fase 1 Completa + Fase 2 Parcial (Clasificador IA)
