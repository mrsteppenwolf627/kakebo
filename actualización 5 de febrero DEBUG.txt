================================================================================
             KAKEBO AI - ESTADO DE DEBUGGING (5 Feb 2026 - 21:46)
             Problema: "Unable to generate response" en el chat
================================================================================

## PROBLEMA IDENTIFICADO

El agente responde con mensajes gen√©ricos porque **el userMessage llega vac√≠o al Router node**.

### Evidencia de los logs:
```
[18:07:18] DEBUG: Router node processing
    module: "api"
    message: ""  ‚Üê ¬°VAC√çO!
```

Esto causa:
- Intent clasificado como "unclear" (no hay nada que clasificar)
- Confidence = 0
- No se ejecutan herramientas
- Respuestas gen√©ricas sin contexto

## HIP√ìTESIS DEL BUG

El problema est√° en c√≥mo LangGraph maneja el estado inicial en `src/lib/agents/graph.ts`:

```typescript
userMessage: {
  value: (x: any) => x,  // Solo devuelve lo que recibe
  default: () => "",      // ‚Üê Si no recibe nada, usa string vac√≠o
},
```

Si el initialState en `src/lib/agents/index.ts` (l√≠nea 65-81) no se pasa correctamente al grafo, el campo `userMessage` toma el valor por defecto (cadena vac√≠a).

## CAMBIOS REALIZADOS PARA DEBUG

1. **A√±adido logs en `src/lib/agents/index.ts`** (l√≠neas 56-57):
   ```typescript
   console.log("üîë OpenAI API Key present:", !!process.env.OPENAI_API_KEY);
   console.log("üìù User message:", userMessage);
   ```

2. **Creado `INSTRUCCIONES.md`**: Gu√≠a de cu√°ndo usar Claude Code vs Antigravity

3. **Creado `scripts/debug-agent.js`**: Script de debug (tiene errores TypeScript, ignorar)

## PR√ìXIMOS PASOS PARA RESOLVER

### 1. Verificar que los logs aparecen
Despu√©s de reiniciar el servidor, enviar un mensaje al chat y verificar que aparezcan:
```
üîë OpenAI API Key present: true
üìù User message: <tu mensaje>
```

Si NO aparecen ‚Üí borrar `.next` y recompilar

### 2. Si los logs S√ç aparecen pero el mensaje sigue vac√≠o en el Router
El problema est√° en el **reducer de LangGraph**. Soluci√≥n:

Cambiar en `src/lib/agents/graph.ts` (l√≠nea 34):
```typescript
// ANTES (MALO):
userMessage: {
  value: (x: any) => x,
  default: () => "",
},

// DESPU√âS (BUENO):
userMessage: {
  value: (left: string | undefined, right: string | undefined) => right ?? left ?? "",
  default: () => "",
},
```

Esto asegura que el valor del estado inicial (`right`) siempre sobrescribe el default.

### 3. Alternativa: Simplificar el reducer
Usar el Annotation API de LangGraph (m√°s moderno):

```typescript
import { Annotation } from "@langchain/langgraph";

const AgentStateAnnotation = Annotation.Root({
  messages: Annotation<BaseMessage[]>({
    reducer: (left, right) => left.concat(right),
    default: () => [],
  }),
  userMessage: Annotation<string>(),  // ‚Üê M√°s simple, usa replace autom√°tico
  userId: Annotation<string>(),
  intent: Annotation<IntentType | null>({ default: () => null }),
  // ... resto de campos
});
```

## ARCHIVOS MODIFICADOS (pendientes de commit)

- `src/lib/agents/index.ts` - Logs de debug a√±adidos
- `INSTRUCCIONES.md` - Nuevo documento
- `scripts/debug-agent.js` - Script debug

## COMANDOS √öTILES

```bash
# Borrar cach√© de Next.js si los logs no aparecen
rm -rf .next
npm run dev

# Ver logs del servidor en tiempo real
# (Los logs importantes empiezan con [HH:MM:SS])

# Probar el endpoint directamente con curl
curl -X POST http://localhost:3000/api/ai/agent \
  -H "Content-Type: application/json" \
  -d '{"message":"hola"}' \
  # (Requiere autenticaci√≥n, usar desde frontend)
```

## CONTEXTO ADICIONAL

- El backend (API + Agente) est√° funcionando correctamente
- OpenAI API key est√° configurada
- El problema es puramente de paso de estado en el grafo
- El frontend est√° enviando el mensaje correctamente (se ve en los logs iniciales)

## PARA CONTINUAR EN EL TRABAJO

1. Hacer `git pull`
2. Leer este archivo (`actualizaci√≥n 5 de febrero DEBUG.txt`)
3. Leer `INSTRUCCIONES.md`
4. Ejecutar `npm run dev`
5. Probar enviar mensaje y verificar logs
6. Aplicar la soluci√≥n del punto 2 si es necesario

================================================================================
Documento creado: 5 de Febrero de 2026 - 21:46
Estado: Bug identificado, soluci√≥n propuesta, pendiente de validaci√≥n
================================================================================
